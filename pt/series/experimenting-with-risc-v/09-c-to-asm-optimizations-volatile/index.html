<!doctype html><html lang=pt-br data-bs-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>C → Assembly: Otimizações, Volatile e o que o compilador pode fazer - Marcos Azevedo (aka psylinux)</title><meta name=description content><meta name=author content="Blog do Marcos Azevedo"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css><link rel=stylesheet href=/css/khata.css><link rel=stylesheet href=/css/code-highlight.css><script src=/js/khata.js></script><script src=/js/code-copy.js></script></head><body class="mx-auto text-white d-flex flex-column p-2"><nav aria-label="Navegação principal"><a class="me-2 fs-4" href=/pt/><i class="bi bi-house-door-fill" aria-hidden=true></i>
<span class=visually-hidden>Início</span>
</a><a class="mx-2 fs-4" href=/pt/menu><i class="bi bi-list" aria-hidden=true></i>
<span class=visually-hidden>Menu</span>
</a><a class="ms-2 fs-4" href=/pt/search><i class="bi bi-search" aria-hidden=true></i>
<span class=visually-hidden>Buscar</span></a><div class="language-switcher d-inline-flex align-items-center gap-2 ms-3" aria-label=Idioma><a href=/series/experimenting-with-risc-v/09-c-to-asm-optimizations-volatile/>English</a>
<span class=fw-semibold>Português</span></div></nav><main class="flex-grow-1 d-flex flex-column"><article><h1 class=my-4>C → Assembly: Otimizações, Volatile e o que o compilador pode fazer</h1><div class="metadata-panel p-2 mb-3 rounded border"><div class="metadata-value mb-1">Author: Marcos Azevedo</div><div class="metadata-value mb-1"><small>Date: <time>2026-01-20</time></small></div><div class="metadata-value mb-1"><small>Reading Time:
5 mins</small></div><div class="metadata-value mb-1"><small>Section:
<a href=/series title=Section>Series</a></small></div><div class="metadata-value mb-1"><small>Categories:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/categories/series title="categories: series">series</a></small></div><div class="metadata-value mb-1"><small>Tags:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/c-lang title="tags: c-lang">c-lang</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/programming title="tags: programming">programming</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/risc-v title="tags: risc-v">risc-v</a></small></div></div><div class="TableOfContents border rounded p-2 ms-2 mb-2"><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#1-o-pipeline-do-compilador-por-que-existem-várias-traduções>1. O pipeline do compilador (por que existem várias “traduções”)</a></li><li><a href=#2-laboratório-prático-um-programa-vários-níveis-de-otimização>2. Laboratório prático: um programa, vários níveis de otimização</a><ul><li><a href=#o-que-observar>O que observar</a></li></ul></li><li><a href=#3-por-que-variáveis-somem-em-builds-otimizadas>3. Por que variáveis somem em builds otimizadas</a><ul><li><a href=#alocação-de-registradores>Alocação de registradores</a></li><li><a href=#encolhimento-de-vida-útil>Encolhimento de vida útil</a></li><li><a href=#inlining>Inlining</a></li></ul></li><li><a href=#4-volatile-significa-deve-realizar-o-acesso>4. volatile significa “deve realizar o acesso”</a><ul><li><a href=#na-prática-volatile-vs-não-volatile>Na prática: volatile vs não-volatile</a></li></ul></li><li><a href=#5-mapeando-c-de-volta-para-assembly-um-método-prático>5. Mapeando C de volta para assembly (um método prático)</a><ul><li><a href=#use-o-assembly-gerado-pelo-compilador-como-ponte>Use o assembly gerado pelo compilador como “ponte”</a></li></ul></li><li><a href=#exercícios>Exercícios</a><ul><li><a href=#como-testar-suas-respostas>Como testar suas respostas</a></li></ul></li><li><a href=#resumo>Resumo</a></li></ul></nav></div><h2 id=tldr>TL;DR</h2><ul><li>Você vai entender como o compilador transforma C em assembly e por que o mesmo C pode parecer totalmente diferente entre <code>-O0</code> e <code>-O2</code>.</li><li>Vai construir um modelo mental prático para:<ul><li>eliminação de código morto,</li><li>eliminação de subexpressões comuns,</li><li>inlining,</li><li>alocação de registradores,</li><li>e como <code>volatile</code> limita essas otimizações.</li></ul></li><li>Vai rodar experimentos e validar resultados com <code>objdump</code> e GDB.</li></ul><hr><h2 id=1-o-pipeline-do-compilador-por-que-existem-várias-traduções>1. O pipeline do compilador (por que existem várias “traduções”)</h2><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart TD
  A[&#34;C source (.c)&#34;] --&gt; B[&#34;Frontend to IR (Intermediate Representation)&#34;]
  B --&gt; C[&#34;Optimizer (depends on -O level)&#34;]
  C --&gt; D[&#34;Backend to assembly (.s)&#34;]
  D --&gt; E[&#34;Assembler to object (.o)&#34;]
  E --&gt; F[&#34;Linker to ELF (.elf)&#34;]
</code></pre><p>.</p><p>Duas consequências:</p><ul><li>“O compilador” não é um passo só; são várias etapas.</li><li><code>-O</code> muda a etapa de otimização, que muda tudo adiante.</li></ul><div class="alert alert-danger my-4" role=alert><div class="fw-bold mb-2">Important</div>Se você não entende otimização, vai interpretar errado disassembly e sessões de debug, especialmente quando variáveis “somem” ou o fluxo de controle não parece nada com o seu C.</div><hr><h2 id=2-laboratório-prático-um-programa-vários-níveis-de-otimização>2. Laboratório prático: um programa, vários níveis de otimização</h2><p>Crie:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// src/opt.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;uart.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>volatile</span> u32 sink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>f</span>(u32 x) {
</span></span><span style=display:flex><span>  u32 a <span style=color:#f92672>=</span> x <span style=color:#f92672>*</span> <span style=color:#ae81ff>3u</span>;
</span></span><span style=display:flex><span>  u32 b <span style=color:#f92672>=</span> x <span style=color:#f92672>*</span> <span style=color:#ae81ff>3u</span>;      <span style=color:#75715e>// mesma expressão de a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  u32 c <span style=color:#f92672>=</span> a <span style=color:#f92672>+</span> b;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ((c <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1u</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0u</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// parece que importa...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    c <span style=color:#f92672>+=</span> <span style=color:#ae81ff>10u</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// armazena o resultado em algum lugar observável
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  sink <span style=color:#f92672>=</span> c;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> c;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  u32 r <span style=color:#f92672>=</span> <span style=color:#a6e22e>f</span>(<span style=color:#ae81ff>7u</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puts</span>(<span style=color:#e6db74>&#34;f(7)=&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puthex32</span>(r);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_putc</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Compile duas variantes:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -g -ffreestanding -nostdlib -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -O0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -T src/link.ld src/start.s src/uart.c src/opt.c -o build/opt_O0.elf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>riscv64-unknown-elf-gcc -g -ffreestanding -nostdlib -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -O2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -T src/link.ld src/start.s src/uart.c src/opt.c -o build/opt_O2.elf
</span></span></code></pre></td></tr></table></div></div><p>Rode os dois:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// Execute, verifique a saída e use CTRL+a x para sair <span style=color:#66d9ef>do</span> qemu;
</span></span><span style=display:flex><span>qemu-system-riscv32 -M virt -nographic -bios none -kernel build/opt_O0.elf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// Execute, verifique a saída e use CTRL+a x para sair <span style=color:#66d9ef>do</span> qemu;
</span></span><span style=display:flex><span>qemu-system-riscv32 -M virt -nographic -bios none -kernel build/opt_O2.elf
</span></span></code></pre></td></tr></table></div></div><p>Faça o disassembly de ambos:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-objdump -d -M numeric,no-aliases build/opt_O0.elf | less
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>riscv64-unknown-elf-objdump -d -M numeric,no-aliases build/opt_O2.elf | less
</span></span></code></pre></td></tr></table></div></div><h3 id=o-que-observar>O que observar</h3><ul><li>Em <code>-O0</code>:<ul><li>mais uso de pilha,</li><li>mais loads/stores,</li><li>variáveis “vivem” como você espera.</li></ul></li><li>Em <code>-O2</code>:<ul><li><code>a</code> e <code>b</code> provavelmente são calculados uma vez,</li><li>branches podem ser simplificados,</li><li>o código pode ser reorganizado.</li></ul></li></ul><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Tip</div>Ao aprender assembly, comece com <code>-O0</code> e <strong>depois</strong> aprenda a reconhecer as formas otimizadas.</div><hr><h2 id=3-por-que-variáveis-somem-em-builds-otimizadas>3. Por que variáveis somem em builds otimizadas</h2><h3 id=alocação-de-registradores>Alocação de registradores</h3><p>Em <code>-O2</code>, o compilador tenta manter valores em registradores e pode nunca materializá-los na memória.</p><h3 id=encolhimento-de-vida-útil>Encolhimento de vida útil</h3><p>Se o valor de uma variável é usado só por um instante, ela pode nunca existir como um local nomeado.</p><h3 id=inlining>Inlining</h3><p>Funções pequenas frequentemente são substituídas pelo seu corpo.</p><div class="alert alert-info my-4" role=alert><div class="fw-bold mb-2">Note</div>É por isso que o GDB mostra <code>&lt;optimized out></code> para algumas variáveis.</div><hr><h2 id=4-volatile-significa-deve-realizar-o-acesso>4. volatile significa “deve realizar o acesso”</h2><p>Um objeto <code>volatile</code> diz ao compilador:</p><ul><li>toda leitura é um load real,</li><li>toda escrita é um store real,</li><li>o compilador não pode remover nem combinar esses acessos,</li><li>o compilador não pode assumir que o valor permanece o mesmo entre acessos.</li></ul><p>Isso é crítico para:</p><ul><li>registradores <strong>MMIO (Memory-Mapped I/O)</strong>,</li><li>estado compartilhado com <strong>ISR (Interrupt Service Routine)</strong>,</li><li>memória modificada externamente.</li></ul><h3 id=na-prática-volatile-vs-não-volatile>Na prática: volatile vs não-volatile</h3><p>Crie:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// src/volatile_demo.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;uart.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>u32 nv_reg;
</span></span><span style=display:flex><span><span style=color:#66d9ef>volatile</span> u32 v_reg;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>demo</span>(u32 x) {
</span></span><span style=display:flex><span>  nv_reg <span style=color:#f92672>=</span> x;
</span></span><span style=display:flex><span>  nv_reg <span style=color:#f92672>=</span> x;     <span style=color:#75715e>// pode ser fundido
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v_reg <span style=color:#f92672>=</span> x;
</span></span><span style=display:flex><span>  v_reg <span style=color:#f92672>=</span> x;      <span style=color:#75715e>// não pode ser fundido
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> nv_reg <span style=color:#f92672>+</span> v_reg;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  u32 r <span style=color:#f92672>=</span> <span style=color:#a6e22e>demo</span>(<span style=color:#ae81ff>0x1234u</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puts</span>(<span style=color:#e6db74>&#34;demo=&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puthex32</span>(r);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_putc</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Compile otimizado e faça o disassembly:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -g -ffreestanding -nostdlib -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -O2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -T src/link.ld src/start.s src/uart.c src/volatile_demo.c -o build/vol_O2.elf
</span></span><span style=display:flex><span>riscv64-unknown-elf-objdump -d -M numeric,no-aliases build/vol_O2.elf | less
</span></span></code></pre></td></tr></table></div></div><p>O que você deve observar:</p><ul><li>O double-store não-volatile pode virar um único store.</li><li>O double-store volatile deve permanecer com <strong>dois</strong> stores.</li></ul><div class="alert alert-warning my-4" role=alert><div class="fw-bold mb-2">Warning</div><code>volatile</code> <strong>não</strong> é um primitivo de sincronização. Ele não cria atomicidade, nem garante ordenação entre núcleos, nem cria barreiras de memória. Para concorrência, use atômicos C11 ou fences explícitos.</div><hr><h2 id=5-mapeando-c-de-volta-para-assembly-um-método-prático>5. Mapeando C de volta para assembly (um método prático)</h2><p>Quando você vê assembly, pergunte:</p><ol><li>Onde estão as entradas? (normalmente <code>a0..a7</code>)</li><li>Onde o valor de retorno vai? (normalmente <code>a0</code>)</li><li>Quais registradores precisam sobreviver a chamadas? (callee-saved <code>s*</code>)</li><li>Quais stores na memória são observáveis? (volatile, globais, chamadas de função)</li></ol><h3 id=use-o-assembly-gerado-pelo-compilador-como-ponte>Use o assembly gerado pelo compilador como “ponte”</h3><p>Gere saída <code>.s</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -S -O0 -ffreestanding -nostdlib -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -o build/opt_O0.s src/opt.c
</span></span><span style=display:flex><span>riscv64-unknown-elf-gcc -S -O2 -ffreestanding -nostdlib -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -o build/opt_O2.s src/opt.c
</span></span></code></pre></td></tr></table></div></div><p>Compare <code>build/opt_O0.s</code> e <code>build/opt_O2.s</code>.</p><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Tip</div>O arquivo <code>.s</code> costuma ser mais fácil de ler do que o <code>objdump</code>, porque preserva rótulos e estrutura.</div><hr><h2 id=exercícios>Exercícios</h2><ol><li>Modifique <code>opt.c</code> para que <code>sink</code> <strong>não</strong> seja volatile. Preveja o que muda em <code>-O2</code>.</li><li>Adicione um <code>uart_putc</code> (ou qualquer chamada externa) e observe como ele “ancora” valores (chamadas são barreiras de otimização).</li><li>Escreva duas funções: uma pequena, outra grande. Observe quando a pequena é inlined.</li></ol><h3 id=como-testar-suas-respostas>Como testar suas respostas</h3><ul><li>Use <code>objdump -d -M numeric,no-aliases</code> para comparar sequências de instruções.</li><li>Use <code>readelf -s</code> para ver se funções ainda existem como símbolos (o inlining pode remover o símbolo).</li></ul><hr><h2 id=resumo>Resumo</h2><p>Você aprendeu o que as otimizações fazem, por que depurar código otimizado pode ser confuso, e o que <code>volatile</code> realmente garante.</p><p>A seguir: <strong>fluxo de controle e acesso a dados</strong>, você vai ver como if/loops/switch viram branches e jump tables, e como loads/stores codificam endereçamento.</p><div class=mt-4><script src=https://giscus.app/client.js data-repo=psylinux/psylinux.github.io data-repo-id=R_kgDORCdA4Q data-category=Comments data-category-id=DIC_kwDORCdA4c4C1fwh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main><div class=footer><div class="mb-4 d-flex flex-row justify-content-around"><div class=mr-4><a href=/pt/series/experimenting-with-risc-v/08-rv32-abi-c-types/ data-toggle=tooltip data-placement=top title="ABI do RV32 e Tipos de Dados em C: Tamanhos, Alinhamento e Layout"><i class="bi bi-chevron-left" style=font-size:2em></i></a></div><div class=ms-4><a href=/pt/series/experimenting-with-risc-v/10-control-flow-data-access/ data-toggle=tooltip data-placement=top title="Fluxo de controle e acesso a dados em assembly RV32"><i class="bi bi-chevron-right" style=font-size:2em></i></a></div></div><footer class="border-top border-light py-2 d-flex flex-row flex-wrap justify-content-between"><div class=copyright><small>psylinux</small></div><div><small>Copyrighted © Marcos Azevedo, 2025.</small></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b1b9cb012238436c9efbac840abc1907"}'></script></div></body></html>