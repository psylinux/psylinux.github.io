<!doctype html><html lang=pt-br data-bs-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>Funções, convenção de chamada e stack frames - Marcos Azevedo (aka psylinux)</title><meta name=description content><meta name=author content="Blog do Marcos Azevedo"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css><link rel=stylesheet href=/css/khata.css><link rel=stylesheet href=/css/code-highlight.css><script src=/js/khata.js></script><script src=/js/code-copy.js></script></head><body class="mx-auto text-white d-flex flex-column p-2"><nav aria-label="Navegação principal"><a class="me-2 fs-4" href=/pt/><i class="bi bi-house-door-fill" aria-hidden=true></i>
<span class=visually-hidden>Início</span>
</a><a class="mx-2 fs-4" href=/pt/menu><i class="bi bi-list" aria-hidden=true></i>
<span class=visually-hidden>Menu</span>
</a><a class="ms-2 fs-4" href=/pt/search><i class="bi bi-search" aria-hidden=true></i>
<span class=visually-hidden>Buscar</span></a><div class="language-switcher d-inline-flex align-items-center gap-2 ms-3" aria-label=Idioma><a href=/series/experimenting-with-risc-v/11-functions-stack-calling-convention/>English</a>
<span class=fw-semibold>Português</span></div></nav><main class="flex-grow-1 d-flex flex-column"><article><h1 class=my-4>Funções, convenção de chamada e stack frames</h1><div class="metadata-panel p-2 mb-3 rounded border"><div class="metadata-value mb-1">Author: Marcos Azevedo</div><div class="metadata-value mb-1"><small>Date: <time>2026-01-20</time></small></div><div class="metadata-value mb-1"><small>Reading Time:
5 mins</small></div><div class="metadata-value mb-1"><small>Section:
<a href=/series title=Section>Series</a></small></div><div class="metadata-value mb-1"><small>Categories:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/categories/series title="categories: series">series</a></small></div><div class="metadata-value mb-1"><small>Tags:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/c-lang title="tags: c-lang">c-lang</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/programming title="tags: programming">programming</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/risc-v title="tags: risc-v">risc-v</a></small></div></div><div class="TableOfContents border rounded p-2 ms-2 mb-2"><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#1-as-duas-instruções-que-definem-chamadas>1. As duas instruções que definem chamadas</a><ul><li><a href=#jal-jump-and-link>jal (Jump And Link)</a></li><li><a href=#jalr-jump-and-link-register>jalr (Jump And Link Register)</a></li></ul></li><li><a href=#2-funções-leaf-vs-non-leaf>2. Funções leaf vs non-leaf</a></li><li><a href=#3-um-stack-frame-canônico>3. Um stack frame canônico</a><ul><li><a href=#o-que-isso-faz>O que isso faz</a></li></ul></li><li><a href=#4-na-prática-forçar-um-stack-frame-claro>4. Na prática: forçar um stack frame claro</a><ul><li><a href=#o-que-localizar>O que localizar</a></li></ul></li><li><a href=#5-depure-a-pilha-com-gdb-comandos-práticos>5. Depure a pilha com GDB (comandos práticos)</a><ul><li><a href=#interpretando-x32wx-sp>Interpretando x/32wx $sp</a></li></ul></li><li><a href=#6-corrupção-de-pilha-como-acontece>6. Corrupção de pilha: como acontece</a><ul><li><a href=#bug-prático-overwrite-off-by-one>Bug prático: overwrite off-by-one</a></li></ul></li><li><a href=#7-argumentos-além-de-a0a7>7. Argumentos além de a0..a7</a></li><li><a href=#exercícios>Exercícios</a><ul><li><a href=#como-testar-suas-respostas>Como testar suas respostas</a></li></ul></li><li><a href=#resumo>Resumo</a></li></ul></nav></div><h2 id=tldr>TL;DR</h2><ul><li>Você vai aprender como chamadas de função são implementadas no RV32 usando o ABI (Application Binary Interface): <code>jal</code>, <code>jalr</code>, o registrador <code>ra</code> (Return Address) e o <code>sp</code> (Stack Pointer).</li><li>Vai aprender a reconhecer <strong>prólogos/epílogos</strong> de função, entender por que registradores são salvos/restaurados, e mapear offsets de pilha para variáveis locais/argumentos em C.</li><li>Vai praticar depuração de pilha com GDB: inspecionar frames, backtraces e memória ao redor de <code>sp</code>.</li></ul><div class="alert alert-danger my-4" role=alert><div class="fw-bold mb-2">Important</div>A maioria dos “crashes misteriosos” no mundo real em firmware ou código de baixo nível se reduz a: <em>convenção de chamada violada</em>, <em>pilha corrompida</em> ou <em>aritmética de ponteiro errada</em>.</div><hr><h2 id=1-as-duas-instruções-que-definem-chamadas>1. As duas instruções que definem chamadas</h2><h3 id=jal-jump-and-link>jal (Jump And Link)</h3><ul><li>Salva <code>pc+4</code> em <code>ra</code> (x1)</li><li>Salta para um alvo</li></ul><h3 id=jalr-jump-and-link-register>jalr (Jump And Link Register)</h3><ul><li>Usada para chamadas indiretas e retornos</li><li>Um retorno é comumente:</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>jalr</span> <span style=color:#66d9ef>x0</span>, <span style=color:#66d9ef>x1</span>, <span style=color:#ae81ff>0</span>   <span style=color:#75715e># salta para ra; descarta o link
</span></span></span></code></pre></td></tr></table></div></div><p>Forma pseudo-instrução:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>ret</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=2-funções-leaf-vs-non-leaf>2. Funções leaf vs non-leaf</h2><ul><li><p><strong>Função leaf</strong>: não chama outras funções</p><ul><li>muitas vezes não precisa salvar <code>ra</code></li><li>às vezes nem toca a pilha</li></ul></li><li><p><strong>Função non-leaf</strong>: chama outras funções</p><ul><li>precisa preservar o endereço de retorno entre chamadas</li><li>normalmente salva <code>ra</code> na pilha</li></ul></li></ul><hr><h2 id=3-um-stack-frame-canônico>3. Um stack frame canônico</h2><p>Um prólogo/epílogo RV32 típico (não universal) é assim:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>addi</span> <span style=color:#66d9ef>sp</span>, <span style=color:#66d9ef>sp</span>, -<span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sw</span>   <span style=color:#66d9ef>ra</span>, <span style=color:#ae81ff>12</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>sw</span>   <span style=color:#66d9ef>s0</span>,  <span style=color:#ae81ff>8</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>addi</span> <span style=color:#66d9ef>s0</span>, <span style=color:#66d9ef>sp</span>, <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># corpo da função
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lw</span>   <span style=color:#66d9ef>ra</span>, <span style=color:#ae81ff>12</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>lw</span>   <span style=color:#66d9ef>s0</span>,  <span style=color:#ae81ff>8</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>addi</span> <span style=color:#66d9ef>sp</span>, <span style=color:#66d9ef>sp</span>, <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ret</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=o-que-isso-faz>O que isso faz</h3><ul><li>Reserva 16 bytes de espaço na pilha</li><li>Salva registradores callee-saved usados pela função (geralmente <code>s0</code>)</li><li>Salva <code>ra</code> se necessário</li><li>Opcionalmente configura <code>s0</code> como frame pointer</li></ul><div class="alert alert-info my-4" role=alert><div class="fw-bold mb-2">Note</div>Alguns compiladores omitem o frame pointer (<code>-fomit-frame-pointer</code>) em builds otimizadas, o que dificulta o unwind da pilha.</div><hr><h2 id=4-na-prática-forçar-um-stack-frame-claro>4. Na prática: forçar um stack frame claro</h2><p>Crie:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// src/stack_demo.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;uart.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline))
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>inner</span>(u32 a, u32 b) {
</span></span><span style=display:flex><span>  u32 x <span style=color:#f92672>=</span> a <span style=color:#f92672>^</span> <span style=color:#ae81ff>0xA5A5A5A5u</span>;
</span></span><span style=display:flex><span>  u32 y <span style=color:#f92672>=</span> b <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1234u</span>;
</span></span><span style=display:flex><span>  u32 z <span style=color:#f92672>=</span> x <span style=color:#f92672>+</span> y;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> z;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline))
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>outer</span>(u32 v) {
</span></span><span style=display:flex><span>  u32 local1 <span style=color:#f92672>=</span> v <span style=color:#f92672>+</span> <span style=color:#ae81ff>1u</span>;
</span></span><span style=display:flex><span>  u32 local2 <span style=color:#f92672>=</span> v <span style=color:#f92672>+</span> <span style=color:#ae81ff>2u</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>inner</span>(local1, local2);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puts</span>(<span style=color:#e6db74>&#34;outer=&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puthex32</span>(<span style=color:#a6e22e>outer</span>(<span style=color:#ae81ff>100u</span>));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_putc</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Compile com flags que ajudam na leitura:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -O0 -g -fno-omit-frame-pointer -ffreestanding -nostdlib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -T src/link.ld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  src/start.s src/uart.c src/stack_demo.c -o build/stack_demo.elf
</span></span></code></pre></td></tr></table></div></div><p>Disassemble:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-objdump -d -M numeric,no-aliases build/stack_demo.elf | less
</span></span></code></pre></td></tr></table></div></div><h3 id=o-que-localizar>O que localizar</h3><ul><li>O prólogo/epílogo de <code>outer</code> e <code>inner</code></li><li>Onde as variáveis locais vivem (offsets na pilha)</li><li>Onde os argumentos são colocados (registradores, e às vezes pilha se são muitos)</li></ul><hr><h2 id=5-depure-a-pilha-com-gdb-comandos-práticos>5. Depure a pilha com GDB (comandos práticos)</h2><p>Rode com o stub do GDB:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qemu-system-riscv32 -S -M virt -nographic -bios none <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -kernel build/stack_demo.elf -gdb tcp::1234
</span></span></code></pre></td></tr></table></div></div><p>Em outro terminal:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gdb-multiarch ./build/stack_demo.elf
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> set architecture riscv:rv32
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> target remote :1234
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b outer
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> c
</span></span></code></pre></td></tr></table></div></div><p>Agora inspecione:</p><pre tabindex=0><code class=language-gdb data-lang=gdb>(gdb) info registers sp ra s0 a0 a1
(gdb) bt
(gdb) info frame
(gdb) x/32wx $sp
(gdb) x/16i $pc
</code></pre><h3 id=interpretando-x32wx-sp>Interpretando x/32wx $sp</h3><p>Você está fazendo dump de 32 words de memória a partir do stack pointer atual.</p><ul><li><code>ra</code> salvo normalmente aparece como um endereço de código</li><li><code>s0</code> salvo pode aparecer</li><li>locais podem aparecer como padrões próximos aos regs salvos</li></ul><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Tip</div>Um hábito muito útil: <strong>antes</strong> de entrar numa chamada, faça dump de <code>$sp</code> e <code>$ra</code>, dê um step, e depois faça dump de novo. Você verá o novo frame sendo construído.</div><hr><h2 id=6-corrupção-de-pilha-como-acontece>6. Corrupção de pilha: como acontece</h2><p>Causas comuns:</p><ul><li>escrever além do fim de um array local</li><li>tamanho errado em <code>memcpy</code></li><li>tratar um ponteiro como um tipo maior do que ele é</li><li>protótipos de função inconsistentes (especialmente com funções variádicas)</li><li>assembly manual que esquece de restaurar registradores callee-saved</li></ul><h3 id=bug-prático-overwrite-off-by-one>Bug prático: overwrite off-by-one</h3><p>Crie:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// src/overflow.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;uart.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline))
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>victim</span>(u32 x) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>volatile</span> u32 canary <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xCAFEBABEu</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>volatile</span> u8 buf[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// BUG: escreve 17 bytes em um buffer de 16 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>16</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    buf[i] <span style=color:#f92672>=</span> (u8)i;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// retorno depende se o canary foi corrompido
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> (canary <span style=color:#f92672>^</span> x);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puthex32</span>(<span style=color:#a6e22e>victim</span>(<span style=color:#ae81ff>0x12345678u</span>));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_putc</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Compile e rode:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -O0 -g -fno-omit-frame-pointer -ffreestanding -nostdlib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -T src/link.ld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  src/start.s src/uart.c src/overflow.c -o build/overflow.elf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qemu-system-riscv32 -M virt -nographic -bios none -kernel build/overflow.elf
</span></span></code></pre></td></tr></table></div></div><p>Agora depure e observe o canary:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qemu-system-riscv32 -S -M virt -nographic -bios none <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -kernel build/overflow.elf -gdb tcp::1234
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code class=language-gdb data-lang=gdb>(gdb) b victim
(gdb) c
(gdb) p/x canary
(gdb) next
(gdb) p/x canary
</code></pre><div class="alert alert-warning my-4" role=alert><div class="fw-bold mb-2">Warning</div>O resultado exato depende das escolhas de layout do compilador, mas o <em>método</em> é a lição: locais na pilha lado a lado significam que um overflow pode corromper estado adjacente (incluindo endereços de retorno salvos, no pior caso).</div><hr><h2 id=7-argumentos-além-de-a0a7>7. Argumentos além de a0..a7</h2><p>O RISC-V usa <code>a0..a7</code> para os primeiros 8 argumentos inteiros/ponteiros.
Argumentos extras são passados na pilha.</p><p>Você pode demonstrar isso escrevendo uma função com 10 argumentos e inspecionando como o call site os prepara.</p><hr><h2 id=exercícios>Exercícios</h2><ol><li>Em <code>stack_demo</code>, identifique quais registradores carregam parâmetros para <code>inner</code>.</li><li>Em <code>stack_demo</code>, determine o offset na pilha (a partir de <code>sp</code> ou <code>s0</code>) de <code>local1</code> e <code>local2</code>, correlacionando disassembly com dumps de memória do GDB.</li><li>Crie uma função com 9 parâmetros inteiros e encontre onde o parâmetro #9 vive.</li><li>No exemplo de overflow, mude o loop para <code>i &lt; 16</code> e confirme que o canary permanece intacto.</li></ol><h3 id=como-testar-suas-respostas>Como testar suas respostas</h3><ul><li>Verifique offsets imprimindo endereços (<code>&amp;local1</code>) em C e comparando com <code>$sp</code> no GDB.</li><li>Use <code>objdump -d -M numeric,no-aliases</code> para confirmar que stores/loads batem com os offsets que você acha.</li></ul><hr><h2 id=resumo>Resumo</h2><p>Você agora entende como chamadas de função no RV32 funcionam: <code>ra</code>, <code>sp</code>, prólogos/epílogos e estrutura de stack frame, e praticou depurar estado de pilha diretamente.</p><p>A seguir: <strong>linker scripts e mapas de memória</strong>, vamos controlar onde código/dados vivem, gerar arquivos <code>.map</code> e explicar por que imagens de firmware costumam começar em endereços como <code>0x80000000</code>.</p><div class=mt-4><script src=https://giscus.app/client.js data-repo=psylinux/psylinux.github.io data-repo-id=R_kgDORCdA4Q data-category=Comments data-category-id=DIC_kwDORCdA4c4C1fwh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main><div class=footer><div class="mb-4 d-flex flex-row justify-content-around"><div class=mr-4><a href=/pt/series/experimenting-with-risc-v/10-control-flow-data-access/ data-toggle=tooltip data-placement=top title="Fluxo de controle e acesso a dados em assembly RV32"><i class="bi bi-chevron-left" style=font-size:2em></i></a></div><div class=ms-4><a href=/pt/series/experimenting-with-risc-v/12-linker-scripts-memory-map/ data-toggle=tooltip data-placement=top title="Scripts de linker, seções e mapas de memória"><i class="bi bi-chevron-right" style=font-size:2em></i></a></div></div><footer class="border-top border-light py-2 d-flex flex-row flex-wrap justify-content-between"><div class=copyright><small>psylinux</small></div><div><small>Copyrighted © Marcos Azevedo, 2025.</small></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b1b9cb012238436c9efbac840abc1907"}'></script></div></body></html>