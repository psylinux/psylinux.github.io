<!doctype html><html lang=pt-br data-bs-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>Artigo :: Usando syscalls do Linux em Assembly - Marcos Azevedo (aka psylinux)</title><meta name=description content><meta name=author content="Blog do Marcos Azevedo"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css><link rel=stylesheet href=/css/khata.css><link rel=stylesheet href=/css/code-highlight.css><script src=/js/khata.js></script><script src=/js/code-copy.js></script></head><body class="mx-auto text-white d-flex flex-column p-2"><nav aria-label="Navegação principal"><a class="me-2 fs-4" href=/pt/><i class="bi bi-house-door-fill" aria-hidden=true></i>
<span class=visually-hidden>Início</span>
</a><a class="mx-2 fs-4" href=/pt/menu><i class="bi bi-list" aria-hidden=true></i>
<span class=visually-hidden>Menu</span>
</a><a class="ms-2 fs-4" href=/pt/search><i class="bi bi-search" aria-hidden=true></i>
<span class=visually-hidden>Buscar</span></a><div class="language-switcher d-inline-flex align-items-center gap-2 ms-3" aria-label=Idioma><a href=/articles/article_linux_syscalls_in_assembly/>English</a>
<span class=fw-semibold>Português</span></div></nav><main class="flex-grow-1 d-flex flex-column"><article><h1 class=my-4>Artigo :: Usando syscalls do Linux em Assembly</h1><div class="metadata-panel p-2 mb-3 rounded border"><div class="metadata-value mb-1"><small>Date: <time>2018-12-28</time></small></div><div class="metadata-value mb-1"><small>Reading Time:
6 mins</small></div><div class="metadata-value mb-1"><small>Section:
<a href=/articles title=Section>Artigos</a></small></div><div class="metadata-value mb-1"><small>Categories:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/categories/articles title="categories: articles">articles</a></small></div><div class="metadata-value mb-1"><small>Tags:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/assembly title="tags: assembly">assembly</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/nasm title="tags: nasm">nasm</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/dev title="tags: dev">dev</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/glibc title="tags: glibc">glibc</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/linux title="tags: linux">linux</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/userland title="tags: userland">userland</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/exploitation title="tags: exploitation">exploitation</a></small></div></div><div class="TableOfContents border rounded p-2 ms-2 mb-2"><nav id=TableOfContents><ul><li><a href=#introdução>Introdução</a></li><li><a href=#visão-geral>Visão Geral</a></li><li><a href=#pré-requisitos>Pré-requisitos</a></li><li><a href=#objetivo>Objetivo</a></li><li><a href=#encontrando-números-de-syscalls>Encontrando Números de Syscalls</a></li><li><a href=#convenções-de-registradores-para-syscalls>Convenções de Registradores para Syscalls</a></li><li><a href=#escrevendo-o-código-assembly>Escrevendo o Código Assembly</a></li><li><a href=#compilando-o-código>Compilando o Código</a></li><li><a href=#adicionando-a-syscall-exit>Adicionando a Syscall Exit</a></li><li><a href=#analisando-com-strace>Analisando com strace</a></li><li><a href=#fluxo-de-execução-de-syscalls>Fluxo de Execução de Syscalls</a></li><li><a href=#pontos-chave>Pontos-Chave</a></li><li><a href=#exercícios-práticos>Exercícios Práticos</a></li><li><a href=#leitura-adicional>Leitura Adicional</a></li></ul></nav></div><h2 id=introdução>Introdução</h2><p>Este tutorial prático ensina como escrever programas assembly que invocam chamadas de sistema do Linux diretamente, ignorando a biblioteca C e interagindo com o kernel no nível mais baixo.</p><h2 id=visão-geral>Visão Geral</h2><p>Quando um programa precisa interagir com o sistema operacional; para escrever em um arquivo, alocar memória ou finalizar graciosamente; ele faz uma <strong>chamada de sistema</strong> (syscall). A maioria dos programadores usa essas chamadas indiretamente através de wrappers da biblioteca C, mas entender como invocar syscalls diretamente do assembly te dá uma visão profunda de como programas realmente funcionam.</p><p>Neste tutorial, vamos construir um programa Linux x64 simples que imprime &ldquo;Hack The Planet&rdquo; na tela usando syscalls puras, sem nenhuma dependência da biblioteca C.</p><h2 id=pré-requisitos>Pré-requisitos</h2><p>Antes de começar, você deve ter:</p><ul><li>Conhecimento básico de linguagem assembly (sintaxe NASM)</li><li>Compreensão de registradores x64 (RAX, RDI, RSI, etc.)</li><li>Assembler NASM e linker ld instalados</li><li>Familiaridade com programação C ajuda mas não é obrigatória</li></ul><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Instalar NASM</div>No Debian/Ubuntu: <code>sudo apt install nasm</code>
No Fedora/RHEL: <code>sudo yum install nasm</code></div><h2 id=objetivo>Objetivo</h2><p>Vamos construir um binário Linux ELF64 que usa syscalls básicas para imprimir uma mensagem na tela. No caminho, vamos aprender:</p><ul><li>Como encontrar números de syscalls</li><li>Como configurar registradores para invocação de syscalls</li><li>Por que programas sofrem segfault sem tratamento adequado de saída</li></ul><h2 id=encontrando-números-de-syscalls>Encontrando Números de Syscalls</h2><p>Cada syscall no Linux tem um número único. Para x64, estes são definidos em um arquivo header. Vamos encontrar a syscall <code>write</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /usr/include/x86_64-linux-gnu/asm/unistd_64.h | grep write
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_write 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_pwrite64 18</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_writev 20</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_pwritev 296</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_process_vm_writev 311</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_pwritev2 328</span>
</span></span></code></pre></td></tr></table></div></div><p>A syscall básica <code>write</code> é o número <strong>1</strong>. Agora vamos consultar o manual para entender seus argumentos:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>man <span style=color:#ae81ff>2</span> write
</span></span></code></pre></td></tr></table></div></div><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/write_syscall_1.png alt="Página do manual da syscall write"></figure><p>Como podemos ver, a syscall <code>write</code> tem três argumentos:</p><p>*<em>ssize_t write(int fd, const void <em>buf, size_t count);</em></em></p><ol><li><strong>fd</strong> - Descritor de arquivo (0=stdin, 1=stdout, 2=stderr)</li><li><strong>buf</strong> - Ponteiro para os dados a escrever</li><li><strong>count</strong> - Número de bytes a escrever</li></ol><h2 id=convenções-de-registradores-para-syscalls>Convenções de Registradores para Syscalls</h2><p>Lendo o manual de syscalls, aprendemos como configurar os registradores x64 para invocar syscalls:</p><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/exit_syscall_reg_1.png alt="Configuração de registradores para syscalls"></figure><p><strong>Mapeamento de registradores para syscalls x64:</strong></p><ol><li><strong>RAX</strong> - Número da syscall</li><li><strong>RDI</strong> - Primeiro argumento</li><li><strong>RSI</strong> - Segundo argumento</li><li><strong>RDX</strong> - Terceiro argumento</li><li><strong>R10</strong> - Quarto argumento</li><li><strong>R8</strong> - Quinto argumento</li><li><strong>R9</strong> - Sexto argumento</li></ol><div class="alert alert-danger my-4" role=alert><div class="fw-bold mb-2">Diferente de Chamadas de Função</div>Essas convenções de registradores são <strong>específicas para syscalls</strong>. Chamadas de função x64 regulares usam uma ABI (Application Binary Interface) diferente. Não confunda as duas!</div><h2 id=escrevendo-o-código-assembly>Escrevendo o Código Assembly</h2><p>Para nosso programa, vamos:</p><ul><li>Usar descritor de arquivo <strong>1</strong> (stdout) para imprimir na tela</li><li>Apontar <strong>RSI</strong> para nossa string de mensagem &ldquo;Hack The Planet&rdquo;</li><li>Definir <strong>RDX</strong> como <strong>16</strong> (o comprimento da nossa mensagem incluindo newline)</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>global</span> <span style=color:#66d9ef>_start</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>section</span> <span style=color:#66d9ef>.text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_start:
</span></span><span style=display:flex><span><span style=color:#75715e>;
</span></span></span><span style=display:flex><span><span style=color:#75715e>; Configurando os registradores para imprimir a mensagem
</span></span></span><span style=display:flex><span><span style=color:#75715e>; usando a syscall &#34;write&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rax</span>, <span style=color:#ae81ff>1</span>          <span style=color:#75715e>; número da syscall para write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rdi</span>, <span style=color:#ae81ff>1</span>          <span style=color:#75715e>; descritor de arquivo 1 = stdout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rsi</span>, <span style=color:#66d9ef>msg</span>        <span style=color:#75715e>; ponteiro para mensagem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rdx</span>, <span style=color:#66d9ef>length</span>     <span style=color:#75715e>; comprimento da mensagem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>syscall</span>             <span style=color:#75715e>; invocar kernel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>section</span> <span style=color:#66d9ef>.data</span>
</span></span><span style=display:flex><span>    msg: <span style=color:#a6e22e>db</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>Hack</span> <span style=color:#66d9ef>The</span> <span style=color:#66d9ef>Planet</span><span style=color:#960050;background-color:#1e0010>&#39;</span>,<span style=color:#ae81ff>0xa</span>    <span style=color:#75715e>; mensagem com newline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    length: <span style=color:#a6e22e>equ</span> <span style=color:#66d9ef>$-msg</span>                 <span style=color:#75715e>; calcular comprimento
</span></span></span></code></pre></td></tr></table></div></div><div class="alert alert-info my-4" role=alert><div class="fw-bold mb-2">Entendendo o cálculo de length</div>A diretiva <code>equ $-msg</code> calcula o comprimento subtraindo o endereço inicial de <code>msg</code> da posição atual <code>$</code>. Isso nos dá automaticamente o tamanho da string.</div><h2 id=compilando-o-código>Compilando o Código</h2><p>Vamos compilar e linkar este código assembly:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nasm -felf64 syscall-001.nasm -o syscall-001.o
</span></span><span style=display:flex><span>ld syscall-001.o -o syscall-001.bin
</span></span></code></pre></td></tr></table></div></div><p><strong>Flags explicadas:</strong></p><ul><li><code>-felf64</code> - Formato de saída é ELF 64-bit (Executable and Linkable Format)</li><li><code>ld</code> - Linka o arquivo objeto em um binário executável</li></ul><p>Quando rodamos nosso programa com <code>./syscall-001.bin</code>, vemos que nossa mensagem &ldquo;Hack The Planet&rdquo; é impressa, mas recebemos um erro <strong>Segmentation Fault</strong>:</p><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/write_syscall_2.png alt="Execução do programa com segfault"></figure><div class="alert alert-warning my-4" role=alert><div class="fw-bold mb-2">Por Que o Segfault?</div>Após imprimir a mensagem, nosso programa não sabe o que fazer em seguida. Ele continua executando quaisquer bytes que seguem na memória, eventualmente atingindo instruções ou memória inválida. Precisamos sair adequadamente!</div><h2 id=adicionando-a-syscall-exit>Adicionando a Syscall Exit</h2><p>Vamos encontrar o número da syscall exit:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /usr/include/x86_64-linux-gnu/asm/unistd_64.h | grep exit
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_exit 60</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __NR_exit_group 231</span>
</span></span></code></pre></td></tr></table></div></div><p>A syscall <code>exit</code> é o número <strong>60</strong>. Vamos consultar sua página de manual:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>man <span style=color:#ae81ff>2</span> exit
</span></span></code></pre></td></tr></table></div></div><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/exit_syscall_1.png alt="Página do manual da syscall exit"></figure><p>Existe apenas um argumento: <strong>int status</strong> (o código de saída, como 0 para sucesso ou diferente de zero para erros).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>_exit</span>(<span style=color:#66d9ef>int</span> status);
</span></span></code></pre></td></tr></table></div></div><p>Vamos adicionar a syscall exit ao nosso programa. Usaremos status de saída <strong>1</strong> para teste:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>global</span> <span style=color:#66d9ef>_start</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>section</span> <span style=color:#66d9ef>.text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_start:
</span></span><span style=display:flex><span><span style=color:#75715e>;
</span></span></span><span style=display:flex><span><span style=color:#75715e>; Configurando os registradores para imprimir a mensagem
</span></span></span><span style=display:flex><span><span style=color:#75715e>; usando a syscall &#34;write&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rax</span>, <span style=color:#ae81ff>1</span>          <span style=color:#75715e>; número da syscall para write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rdi</span>, <span style=color:#ae81ff>1</span>          <span style=color:#75715e>; descritor de arquivo 1 = stdout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rsi</span>, <span style=color:#66d9ef>msg</span>        <span style=color:#75715e>; ponteiro para mensagem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rdx</span>, <span style=color:#66d9ef>length</span>     <span style=color:#75715e>; comprimento da mensagem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>syscall</span>             <span style=color:#75715e>; invocar kernel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>;
</span></span></span><span style=display:flex><span><span style=color:#75715e>; Configurando os registradores para chamar a syscall &#34;exit&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>; e sair normalmente com retorno 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>; Nota: se comentarmos isso o processo finalizará com
</span></span></span><span style=display:flex><span><span style=color:#75715e>; erro Segmentation Fault
</span></span></span><span style=display:flex><span><span style=color:#75715e>;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rax</span>, <span style=color:#ae81ff>60</span>         <span style=color:#75715e>; número da syscall para exit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rdi</span>, <span style=color:#ae81ff>1</span>          <span style=color:#75715e>; código de status de saída
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>syscall</span>             <span style=color:#75715e>; invocar kernel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>section</span> <span style=color:#66d9ef>.data</span>
</span></span><span style=display:flex><span>    msg: <span style=color:#a6e22e>db</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>Hack</span> <span style=color:#66d9ef>The</span> <span style=color:#66d9ef>Planet</span><span style=color:#960050;background-color:#1e0010>&#39;</span>,<span style=color:#ae81ff>0xa</span>
</span></span><span style=display:flex><span>    length: <span style=color:#a6e22e>equ</span> <span style=color:#66d9ef>$-msg</span>
</span></span></code></pre></td></tr></table></div></div><p>Agora compile novamente:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nasm -felf64 syscall-001.nasm -o syscall-001.o
</span></span><span style=display:flex><span>ld syscall-001.o -o syscall-001.bin
</span></span></code></pre></td></tr></table></div></div><p>Após executar <code>./syscall-001.bin</code>, podemos verificar que o status de saída é <strong>1</strong> como projetado:</p><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/exit_syscall_2.png alt="Execução do programa com status de saída 1"></figure><p>Perfeito! Sem segfault. O programa sai limpo.</p><h2 id=analisando-com-strace>Analisando com strace</h2><p>Se usarmos <code>strace</code> para analisar este binário ELF64, veremos detalhes interessantes. Quando executamos o binário, o shell usa <code>execve</code> com nosso binário como argumento junto com variáveis de ambiente:</p><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/exit_syscall_3.png alt="Saída do strace mostrando execve"></figure><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/execve_1.png alt="Detalhes da syscall execve"></figure><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Entendendo a saída do strace</div>O strace nos mostra as syscalls exatas que nosso programa faz, incluindo seus argumentos e valores de retorno. Isso é inestimável para depuração e compreensão do comportamento do programa. Leia nosso artigo <a href=/blog/article_debugging_with_strace.pt/>Depurando com strace</a> para saber mais.</div><hr><h2 id=fluxo-de-execução-de-syscalls>Fluxo de Execução de Syscalls</h2><p>Veja como as syscalls funcionam nos bastidores:</p><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/syscall_execution_1.png alt="Diagrama de fluxo de execução de syscalls"></figure><figure id=figure-1 class="mt-4 pt-2"><img class="mw-100 rounded" src=/pics/syscall_execution_2.png alt="Detalhes da execução de syscalls"></figure><p><strong>O processo:</strong></p><ol><li>Programa do usuário configura registradores (RAX para número da syscall, RDI/RSI/RDX para argumentos)</li><li>Instrução <code>syscall</code> dispara uma troca de contexto para modo kernel</li><li>Kernel valida argumentos e executa a operação solicitada</li><li>Kernel retorna controle ao userland com resultado em RAX</li><li>Programa continua a execução</li></ol><h2 id=pontos-chave>Pontos-Chave</h2><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Resumo Rápido</div><ul><li><strong>Syscalls</strong> são a interface entre programas em userland e o kernel</li><li><strong>Números de syscalls x64</strong> são definidos em <code>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</code></li><li><strong>Convenção de registradores</strong>: RAX=número da syscall, RDI/RSI/RDX/R10/R8/R9 para argumentos</li><li><strong>Sempre chame exit</strong> para terminar programas graciosamente (syscall 60 no x64)</li><li><strong>strace</strong> é essencial para entender e depurar comportamento de syscalls</li><li><strong>Não precisa de biblioteca C</strong> - você pode interagir diretamente com o kernel</li></ul></div><h2 id=exercícios-práticos>Exercícios Práticos</h2><div class="alert alert-danger my-4" role=alert><div class="fw-bold mb-2">Experimente Você Mesmo</div><ol><li>Modifique o programa para escrever em stderr (descritor de arquivo 2) em vez de stdout</li><li>Crie um programa que use a syscall <code>read</code> (número 0) para obter entrada do usuário</li><li>Escreva um programa que abre um arquivo usando a syscall <code>open</code> (número 2)</li><li>Adicione verificação de erros examinando o valor de retorno em RAX após cada syscall</li><li>Use strace em utilitários do sistema como <code>ls</code> e identifique as syscalls que eles fazem</li></ol></div><h2 id=leitura-adicional>Leitura Adicional</h2><ul><li><a href=/blog/article_debugging_with_strace.pt/>Depurando com strace</a> - Aprenda a rastrear e depurar syscalls</li><li><a href=/blog/article_getting_start_with_gdb.pt/>Começando com GDB</a> - Depure seus programas assembly</li><li><a href=/blog/cheatsheet_gcc_compiling.pt/>Cheat Sheet de Compilação GCC</a> - Referência de compilação e linkagem</li><li><a href=https://man7.org/linux/man-pages/man2/syscalls.2.html>Referência de Syscalls do Linux</a> - Documentação completa de syscalls</li><li><a href=https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf>Documentação ABI x64</a> - Convenções de chamada x86-64 oficiais</li></ul><div class=mt-4><script src=https://giscus.app/client.js data-repo=psylinux/psylinux.github.io data-repo-id=R_kgDORCdA4Q data-category=Comments data-category-id=DIC_kwDORCdA4c4C1fwh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main><div class=footer><div class="mb-4 d-flex flex-row justify-content-around"><div class=mr-4><a href=/pt/articles/article_debugging_with_strace/ data-toggle=tooltip data-placement=top title="Artigo :: Debugando com strace"><i class="bi bi-chevron-left" style=font-size:2em></i></a></div><div class=ms-4><a href=/pt/articles/article_getting_start_with_gdb/ data-toggle=tooltip data-placement=top title="Artigo :: Começando com GDB"><i class="bi bi-chevron-right" style=font-size:2em></i></a></div></div><footer class="border-top border-light py-2 d-flex flex-row flex-wrap justify-content-between"><div class=copyright><small>psylinux</small></div><div><small>Copyrighted © Marcos Azevedo, 2025.</small></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b1b9cb012238436c9efbac840abc1907"}'></script></div></body></html>