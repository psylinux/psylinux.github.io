<!doctype html><html lang=en-us data-bs-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>Functions, Calling Convention, and Stack Frames - Marcos Azevedo (aka psylinux)</title><meta name=description content><meta name=author content="Marcos Azevedo Blog"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css><link rel=stylesheet href=/css/khata.css><link rel=stylesheet href=/css/code-highlight.css><script src=/js/khata.js></script><script src=/js/code-copy.js></script></head><body class="mx-auto text-white d-flex flex-column p-2"><nav aria-label="Primary navigation"><a class="me-2 fs-4" href=/><i class="bi bi-house-door-fill" aria-hidden=true></i>
<span class=visually-hidden>Home</span>
</a><a class="mx-2 fs-4" href=/menu><i class="bi bi-list" aria-hidden=true></i>
<span class=visually-hidden>Menu</span>
</a><a class="ms-2 fs-4" href=/search><i class="bi bi-search" aria-hidden=true></i>
<span class=visually-hidden>Search</span></a><div class="language-switcher d-inline-flex align-items-center gap-2 ms-3" aria-label=Language><span class=fw-semibold>English</span>
<a href=/pt/series/experimenting-with-risc-v/11-functions-stack-calling-convention/>Português</a></div></nav><main class="flex-grow-1 d-flex flex-column"><article><h1 class=my-4>Functions, Calling Convention, and Stack Frames</h1><div class="metadata-panel p-2 mb-3 rounded border"><div class="metadata-value mb-1">Author: Marcos Azevedo</div><div class="metadata-value mb-1"><small>Date: <time>2026-01-20</time></small></div><div class="metadata-value mb-1"><small>Reading Time:
5 mins</small></div><div class="metadata-value mb-1"><small>Section:
<a href=/series title=Section>Series</a></small></div><div class="metadata-value mb-1"><small>Categories:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/categories/series title="categories: series">series</a></small></div><div class="metadata-value mb-1"><small>Tags:
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/c-lang title="tags: c-lang">c-lang</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/programming title="tags: programming">programming</a>
<a class="px-1 mx-1 rounded border border-secondary bg-taxa" href=/tags/risc-v title="tags: risc-v">risc-v</a></small></div></div><div class="TableOfContents border rounded p-2 ms-2 mb-2"><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#1-the-two-instructions-that-define-calls>1. The two instructions that define calls</a><ul><li><a href=#jal-jump-and-link>jal (Jump And Link)</a></li><li><a href=#jalr-jump-and-link-register>jalr (Jump And Link Register)</a></li></ul></li><li><a href=#2-leaf-vs-non-leaf-functions>2. Leaf vs non-leaf functions</a></li><li><a href=#3-a-canonical-stack-frame>3. A canonical stack frame</a><ul><li><a href=#what-this-is-doing>What this is doing</a></li></ul></li><li><a href=#4-hands-on-force-a-clear-stack-frame>4. Hands-on: force a clear stack frame</a><ul><li><a href=#what-to-locate>What to locate</a></li></ul></li><li><a href=#5-debug-the-stack-with-gdb-practical-commands>5. Debug the stack with GDB (practical commands)</a><ul><li><a href=#interpreting-x32wx-sp>Interpreting x/32wx $sp</a></li></ul></li><li><a href=#6-stack-corruption-how-it-happens>6. Stack corruption: how it happens</a><ul><li><a href=#hands-on-bug-off-by-one-overwrite>Hands-on bug: off-by-one overwrite</a></li></ul></li><li><a href=#7-arguments-beyond-a0a7>7. Arguments beyond a0..a7</a></li><li><a href=#exercises>Exercises</a><ul><li><a href=#how-to-test-your-answers>How to test your answers</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div><h2 id=tldr>TL;DR</h2><ul><li>You’ll learn how function calls are implemented on RV32 using the ABI (Application Binary Interface): <code>jal</code>, <code>jalr</code>, the <code>ra</code> (Return Address) register, and the <code>sp</code> (Stack Pointer).</li><li>You’ll learn to recognize function <strong>prologues/epilogues</strong>, understand why registers are saved/restored, and map stack offsets to C locals/arguments.</li><li>You’ll practice debugging the stack with GDB: inspecting frames, backtraces, and memory around <code>sp</code>.</li></ul><div class="alert alert-danger my-4" role=alert><div class="fw-bold mb-2">Important</div>Most real-world “mystery crashes” in firmware or low-level code reduce to: <em>calling convention violated</em>, <em>stack corrupted</em>, or <em>bad pointer arithmetic</em>.</div><hr><h2 id=1-the-two-instructions-that-define-calls>1. The two instructions that define calls</h2><h3 id=jal-jump-and-link>jal (Jump And Link)</h3><ul><li>Saves <code>pc+4</code> into <code>ra</code> (x1)</li><li>Jumps to a target</li></ul><h3 id=jalr-jump-and-link-register>jalr (Jump And Link Register)</h3><ul><li>Used for indirect calls and returns</li><li>A return is commonly:</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>jalr</span> <span style=color:#66d9ef>x0</span>, <span style=color:#66d9ef>x1</span>, <span style=color:#ae81ff>0</span>   <span style=color:#75715e># jump to ra; discard link
</span></span></span></code></pre></td></tr></table></div></div><p>Pseudo-instruction form:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>ret</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=2-leaf-vs-non-leaf-functions>2. Leaf vs non-leaf functions</h2><ul><li><p><strong>Leaf function</strong>: calls no other functions</p><ul><li>can often avoid saving <code>ra</code></li><li>can sometimes avoid touching the stack</li></ul></li><li><p><strong>Non-leaf function</strong>: calls other functions</p><ul><li>must preserve return address across those calls</li><li>typically saves <code>ra</code> to the stack</li></ul></li></ul><hr><h2 id=3-a-canonical-stack-frame>3. A canonical stack frame</h2><p>A typical (not universal) RV32 prologue/epilogue looks like:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>addi</span> <span style=color:#66d9ef>sp</span>, <span style=color:#66d9ef>sp</span>, -<span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sw</span>   <span style=color:#66d9ef>ra</span>, <span style=color:#ae81ff>12</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>sw</span>   <span style=color:#66d9ef>s0</span>,  <span style=color:#ae81ff>8</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>addi</span> <span style=color:#66d9ef>s0</span>, <span style=color:#66d9ef>sp</span>, <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># function body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lw</span>   <span style=color:#66d9ef>ra</span>, <span style=color:#ae81ff>12</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>lw</span>   <span style=color:#66d9ef>s0</span>,  <span style=color:#ae81ff>8</span>(<span style=color:#66d9ef>sp</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>addi</span> <span style=color:#66d9ef>sp</span>, <span style=color:#66d9ef>sp</span>, <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ret</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=what-this-is-doing>What this is doing</h3><ul><li>Reserve 16 bytes of stack space</li><li>Save callee-saved regs used by the function (often <code>s0</code>)</li><li>Save <code>ra</code> if needed</li><li>Optionally set <code>s0</code> as a frame pointer</li></ul><div class="alert alert-info my-4" role=alert><div class="fw-bold mb-2">Note</div>Some compilers omit the frame pointer (<code>-fomit-frame-pointer</code>) in optimized builds, which makes stack unwinding harder.</div><hr><h2 id=4-hands-on-force-a-clear-stack-frame>4. Hands-on: force a clear stack frame</h2><p>Create:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// src/stack_demo.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;uart.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline))
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>inner</span>(u32 a, u32 b) {
</span></span><span style=display:flex><span>  u32 x <span style=color:#f92672>=</span> a <span style=color:#f92672>^</span> <span style=color:#ae81ff>0xA5A5A5A5u</span>;
</span></span><span style=display:flex><span>  u32 y <span style=color:#f92672>=</span> b <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1234u</span>;
</span></span><span style=display:flex><span>  u32 z <span style=color:#f92672>=</span> x <span style=color:#f92672>+</span> y;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> z;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline))
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>outer</span>(u32 v) {
</span></span><span style=display:flex><span>  u32 local1 <span style=color:#f92672>=</span> v <span style=color:#f92672>+</span> <span style=color:#ae81ff>1u</span>;
</span></span><span style=display:flex><span>  u32 local2 <span style=color:#f92672>=</span> v <span style=color:#f92672>+</span> <span style=color:#ae81ff>2u</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>inner</span>(local1, local2);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puts</span>(<span style=color:#e6db74>&#34;outer=&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puthex32</span>(<span style=color:#a6e22e>outer</span>(<span style=color:#ae81ff>100u</span>));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_putc</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Build with flags that help readability:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -O0 -g -fno-omit-frame-pointer -ffreestanding -nostdlib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -T src/link.ld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  src/start.s src/uart.c src/stack_demo.c -o build/stack_demo.elf
</span></span></code></pre></td></tr></table></div></div><p>Disassemble:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-objdump -d -M numeric,no-aliases build/stack_demo.elf | less
</span></span></code></pre></td></tr></table></div></div><h3 id=what-to-locate>What to locate</h3><ul><li>The prologue/epilogue of <code>outer</code> and <code>inner</code></li><li>Where locals live (stack offsets)</li><li>Where arguments are placed (registers, and sometimes stack if too many)</li></ul><hr><h2 id=5-debug-the-stack-with-gdb-practical-commands>5. Debug the stack with GDB (practical commands)</h2><p>Run with a GDB stub:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qemu-system-riscv32 -S -M virt -nographic -bios none <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -kernel build/stack_demo.elf -gdb tcp::1234
</span></span></code></pre></td></tr></table></div></div><p>In another terminal:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gdb-multiarch ./build/stack_demo.elf
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> set architecture riscv:rv32
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> target remote :1234
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b outer
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> c
</span></span></code></pre></td></tr></table></div></div><p>Now inspect:</p><pre tabindex=0><code class=language-gdb data-lang=gdb>(gdb) info registers sp ra s0 a0 a1
(gdb) bt
(gdb) info frame
(gdb) x/32wx $sp
(gdb) x/16i $pc
</code></pre><h3 id=interpreting-x32wx-sp>Interpreting x/32wx $sp</h3><p>You are dumping 32 words of memory starting at the current stack pointer.</p><ul><li>saved <code>ra</code> will often be visible as a code address</li><li>saved <code>s0</code> may be visible</li><li>locals may appear as patterns near the saved regs</li></ul><div class="alert alert-success my-4" role=alert><div class="fw-bold mb-2">Tip</div>A very useful habit: <strong>before</strong> stepping into a call, dump <code>$sp</code> and <code>$ra</code>, step, then dump again. You’ll see the new frame being built.</div><hr><h2 id=6-stack-corruption-how-it-happens>6. Stack corruption: how it happens</h2><p>Common causes:</p><ul><li>writing past the end of a local array</li><li>wrong <code>memcpy</code> length</li><li>treating a pointer as a bigger type than it is</li><li>mismatched function prototypes (especially with variadic functions)</li><li>hand-written assembly that forgets to restore callee-saved registers</li></ul><h3 id=hands-on-bug-off-by-one-overwrite>Hands-on bug: off-by-one overwrite</h3><p>Create:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// src/overflow.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;types.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;uart.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline))
</span></span><span style=display:flex><span>u32 <span style=color:#a6e22e>victim</span>(u32 x) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>volatile</span> u32 canary <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xCAFEBABEu</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>volatile</span> u8 buf[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// BUG: writes 17 bytes into a 16-byte buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>16</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    buf[i] <span style=color:#f92672>=</span> (u8)i;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// return depends on whether canary got corrupted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> (canary <span style=color:#f92672>^</span> x);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_puthex32</span>(<span style=color:#a6e22e>victim</span>(<span style=color:#ae81ff>0x12345678u</span>));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uart_putc</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Build and run:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>riscv64-unknown-elf-gcc -O0 -g -fno-omit-frame-pointer -ffreestanding -nostdlib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -march<span style=color:#f92672>=</span>rv32im -mabi<span style=color:#f92672>=</span>ilp32 -T src/link.ld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  src/start.s src/uart.c src/overflow.c -o build/overflow.elf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qemu-system-riscv32 -M virt -nographic -bios none -kernel build/overflow.elf
</span></span></code></pre></td></tr></table></div></div><p>Now debug it and watch the canary:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qemu-system-riscv32 -S -M virt -nographic -bios none <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -kernel build/overflow.elf -gdb tcp::1234
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code class=language-gdb data-lang=gdb>(gdb) b victim
(gdb) c
(gdb) p/x canary
(gdb) next
(gdb) p/x canary
</code></pre><div class="alert alert-warning my-4" role=alert><div class="fw-bold mb-2">Warning</div>The exact outcome depends on compiler layout choices, but the <em>method</em> is the lesson: stack locals next to each other means an overflow can corrupt adjacent state (including saved return addresses in the worst case).</div><hr><h2 id=7-arguments-beyond-a0a7>7. Arguments beyond a0..a7</h2><p>RISC-V uses <code>a0..a7</code> for the first 8 integer/pointer arguments.
Extra arguments are passed on the stack.</p><p>You can demonstrate this by writing a function with 10 arguments and inspecting how the call site prepares them.</p><hr><h2 id=exercises>Exercises</h2><ol><li>In <code>stack_demo</code>, identify which registers carry parameters into <code>inner</code>.</li><li>In <code>stack_demo</code>, determine the stack offset (from <code>sp</code> or <code>s0</code>) of <code>local1</code> and <code>local2</code> by correlating disassembly with GDB memory dumps.</li><li>Create a function with 9 integer parameters and find where parameter #9 lives.</li><li>In the overflow example, change the loop back to <code>i &lt; 16</code> and confirm the canary stays unchanged.</li></ol><h3 id=how-to-test-your-answers>How to test your answers</h3><ul><li>Verify offsets by printing addresses (<code>&amp;local1</code>) in C and comparing to <code>$sp</code> in GDB.</li><li>Use <code>objdump -d -M numeric,no-aliases</code> to confirm stores/loads match the offsets you believe.</li></ul><hr><h2 id=summary>Summary</h2><p>You now understand how RV32 function calls work: <code>ra</code>, <code>sp</code>, prologues/epilogues, and stack-frame structure-and you practiced debugging stack state directly.</p><p>Next: <strong>linker scripts and memory maps</strong>-we’ll control where code/data live, generate <code>.map</code> files, and explain why firmware images often start at addresses like <code>0x80000000</code>.</p><div class=mt-4><script src=https://giscus.app/client.js data-repo=psylinux/psylinux.github.io data-repo-id=R_kgDORCdA4Q data-category=Comments data-category-id=DIC_kwDORCdA4c4C1fwh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main><div class=footer><div class="mb-4 d-flex flex-row justify-content-around"><div class=mr-4><a href=/series/experimenting-with-risc-v/10-control-flow-data-access/ data-toggle=tooltip data-placement=top title="Control Flow and Data Access in RV32 Assembly"><i class="bi bi-chevron-left" style=font-size:2em></i></a></div><div class=ms-4><a href=/series/experimenting-with-risc-v/12-linker-scripts-memory-map/ data-toggle=tooltip data-placement=top title="Linker Scripts, Sections, and Memory Maps"><i class="bi bi-chevron-right" style=font-size:2em></i></a></div></div><footer class="border-top border-light py-2 d-flex flex-row flex-wrap justify-content-between"><div class=copyright><small>psylinux</small></div><div><small>Copyrighted © Marcos Azevedo, 2025.</small></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b1b9cb012238436c9efbac840abc1907"}'></script></div></body></html>